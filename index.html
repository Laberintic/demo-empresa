<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haptic Announcement</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: #ffffff;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            display: none;
            height: 100vh;
            padding: 20px;
            text-align: center;
        }
        .screen.active {
            display: block;
        }

        .scan-btn {
            width: 260px;
            height: 60px;
            border-radius: 12px;
            border: none;
            background: #006492;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            gap: 10px;
        }
        .scan-btn:hover { background: #004e70; }

        /* Scanner overlay */
        #scanner-overlay {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
        }

        /* Main app layout */
        #screen-app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-bar {
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            font-weight: bold;
            background: #ffffff;
            color: #222;
            border-bottom: 1px solid #ddd;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }
        .content-area.show {
            display: block;
        }

        .nav-bar {
            height: 80px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #ddd;
            background: #fff;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 10px;
            color: #666;
        }

        .nav-item.active {
            color: #006492;
            background: #e5f5ff;
        }

        /* Notification overlay */
        #notification-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 9999;
            padding: 20px;
        }
        #notification-overlay.active {
            display: flex;
        }

        .alert-title {
            font-size: 2.2rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .alert-btn {
            margin-top: 30px;
            padding: 14px 28px;
            background: white;
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- ONBOARDING SCREEN -->
    <div id="screen-onboarding" class="screen active">
        <span class="material-symbols-outlined" style="font-size: 64px; color: #006492; margin-bottom: 20px;">assist_walker</span>
        <h1>Haptic Connect</h1>
        <p style="font-size: 1.2rem; max-width: 300px; margin: 0 auto 40px auto; color: #555;">
            Scan the venue code to tune into the announcement system.
        </p>
        <button class="scan-btn" onclick="startActualScan()">
            <span class="material-symbols-outlined">qr_code_scanner</span>
            Scan Station
        </button>
    </div>

    <!-- CAMERA SCANNER OVERLAY -->
    <div id="scanner-overlay">
        <div id="reader" style="width:300px; height:300px;"></div>
        <p style="color:white; margin-top:20px; font-size:1.2rem;">Scanning...</p>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="screen-app" class="screen">
        <div class="top-bar">Haptic Line 6-7</div>

        <div id="tab-home" class="content-area show">
            <h2>Welcome!</h2>
            <p>This device will notify you of important announcements.</p>
        </div>

        <div id="tab-info" class="content-area">
            <h2>Information</h2>
            <p>Venue info and safety instructions.</p>
        </div>

        <div id="tab-settings" class="content-area">
            <h2>Settings</h2>
            <p>Configure preferences here.</p>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="switchTab('home', this)">
                <span class="material-symbols-outlined">home</span>
                Home
            </div>
            <div class="nav-item" onclick="switchTab('info', this)">
                <span class="material-symbols-outlined">info</span>
                Info
            </div>
            <div class="nav-item" onclick="switchTab('settings', this)">
                <span class="material-symbols-outlined">settings</span>
                Settings
            </div>
        </div>
    </div>

    <!-- ALERT OVERLAY -->
    <div id="notification-overlay">
        <div class="alert-title">ALERT</div>
        <div id="alert-message" style="font-size:1.5rem; margin-bottom:20px;">ATTENTION</div>
        <button class="alert-btn" onclick="dismissAlert()">Okay</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyBMw4lAz5iaPSpkK7KaVnFP-cejMTTMHPc",
        authDomain: "fir-empresa-bb9fb.firebaseapp.com",
        databaseURL: "https://fir-empresa-bb9fb-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "fir-empresa-bb9fb",
        storageBucket: "fir-empresa-bb9fb.firebasestorage.app",
        messagingSenderId: "149404088172",
        appId: "1:149404088172:web:3904114b983e9e24266549",
        measurementId: "G-EZP601GZP0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    let html5QrCode = null;

    window.startActualScan = async function() {

        alertSound.play().then(() => { 
            alertSound.pause(); 
            alertSound.currentTime = 0; 
        }).catch(() => {});

        document.getElementById('scanner-overlay').style.display = 'flex';

        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }

        const config = { fps: 10, qrbox: 250 };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            qrText => {
                if (qrText.trim() === "sixseven") {
                    html5QrCode.stop();
                    document.getElementById('scanner-overlay').style.display = 'none';
                    document.getElementById('screen-onboarding').classList.remove('active');
                    document.getElementById('screen-app').classList.add('active');
                }
            },
            error => {}
        );
    }

    /* ---- Tabs ---- */
    window.switchTab = function(tabName, btnElement) {
        document.querySelectorAll('.content-area').forEach(el => el.classList.remove('show'));
        document.getElementById('tab-' + tabName).classList.add('show');

        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btnElement.classList.add('active');
    }

    /* ---- Alerts ---- */
    const overlay = document.getElementById('notification-overlay');
    const messageEl = document.getElementById('alert-message');
    let lastTimestamp = Date.now();

    const alertsRef = ref(db, 'announcements/latest');

    onValue(alertsRef, snapshot => {
        const data = snapshot.val();
        if (data && data.timestamp > lastTimestamp) {
            triggerNotification(data.message);
            lastTimestamp = data.timestamp;
        }
    });

    window.triggerNotification = function(msg) {
        messageEl.innerText = msg || "ATTENTION";
        overlay.classList.add('active');
        alertSound.play().catch(e => {});
        if (navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
    }

    window.dismissAlert = function() {
        overlay.classList.remove('active');
        if (navigator.vibrate) navigator.vibrate(0);
        switchTab('home', document.querySelector('.nav-item:first-child'));
    }
</script>

</body>
</html>
