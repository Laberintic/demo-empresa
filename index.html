<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haptic Announcement</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --md-sys-color-primary: #006492;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #cae6ff;
            --md-sys-color-on-primary-container: #001e30;
            --md-sys-color-background: #f8fdff;
            --md-sys-color-on-background: #001f2b;
            --md-sys-color-surface: #f8fdff;
            --md-sys-color-surface-variant: #dde3ea;
            --md-sys-color-error: #ba1a1a;
            --font-family: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--md-sys-color-background);
        }
        .screen.active { display: flex; }

        /* --- ONBOARDING (Centered) --- */
        #screen-onboarding {
            display: none; /* Controlled by JS classes usually, but default hidden */
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            z-index: 50;
        }
        #screen-onboarding.active { display: flex; }

        .scan-btn {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 30px auto 0 auto; /* Center horizontal */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- REAL SCANNER UI --- */
        #scanner-ui-container {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 2000;
            display: none; /* Starts hidden */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* The library injects video here. We MUST give it size. */
        #reader {
            width: 100%;
            max-width: 500px;
            background: #000;
            margin-bottom: 20px;
        }

        .scanner-info { color: white; margin-top: 10px; font-size: 1.1rem; text-align: center; }
        .error-log { color: #ff8888; font-size: 0.8rem; margin-top: 10px; max-width: 90%; word-break: break-all; }

        .dismiss-btn {
            background: white; color: black; border: none;
            padding: 15px 40px; font-size: 1.2rem; border-radius: 50px;
            margin-top: 20px; cursor: pointer;
        }

        /* --- MAIN APP (Unchanged) --- */
        #screen-app { padding-bottom: 80px; }
        .app-header {
            padding: 20px; background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
        }
        .content-area { flex: 1; overflow-y: auto; padding: 16px; display: none; flex-direction: column; align-items: center; }
        .content-area.show { display: flex; }
        
        /* Navigation & Alerts */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: var(--md-sys-color-surface); border-top: 1px solid #e0e0e0;
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { border: none; background: transparent; color: #5f6368; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--md-sys-color-on-primary-container); }
        .nav-item.active span:first-child { background: var(--md-sys-color-primary-container); padding: 4px 20px; border-radius: 16px; }

        #notification-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--md-sys-color-error); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translateY(100%); transition: transform 0.4s;
        }
        #notification-overlay.active { transform: translateY(0); animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: #ba1a1a; } 50% { background-color: #ff5449; } }
        
        /* List Styles */
        .list-card {
            background: var(--md-sys-color-surface-variant); width: 100%; border-radius: 12px;
            padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px;
        }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen active">
        <div>
            <span class="material-symbols-outlined" style="font-size: 64px; color: #006492; margin-bottom: 20px;">assist_walker</span>
            <h1>Haptic Connect</h1>
            <p>Scan venue code to tune in.</p>
            <button class="scan-btn" onclick="startCameraSequence()">
                <span class="material-symbols-outlined">qr_code_scanner</span>
                Scan Station
            </button>
        </div>
    </div>

    <div id="scanner-ui-container">
        <div id="reader"></div>
        <div class="scanner-info">Scan code <strong>67</strong></div>
        <div id="error-output" class="error-log"></div>
        <button class="dismiss-btn" onclick="cancelScan()">Cancel</button>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-header">
            <h2 id="station-name">Grand Central</h2>
            <span>Connected â€¢ Channel 1</span>
        </div>

        <div id="tab-home" class="content-area show">
            <span class="material-symbols-outlined" style="font-size: 100px; color: #006492; margin-top: 40px;">hearing_disabled</span>
            <h2>Listening...</h2>
        </div>

        <div id="tab-history" class="content-area">
            <h3>Past Stations</h3>
            <div class="list-card"><strong>Penn Station</strong></div>
            <div class="list-card"><strong>JFK Terminal 4</strong></div>
        </div>

        <div id="tab-profile" class="content-area">
            <h3 style="margin-bottom:30px">Demo User</h3>
            <div class="list-card" onclick="location.reload()"><strong>Disconnect</strong></div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home', this)"><span class="material-symbols-outlined">notifications</span><span>Live</span></button>
            <button class="nav-item" onclick="switchTab('history', this)"><span class="material-symbols-outlined">history</span><span>History</span></button>
            <button class="nav-item" onclick="switchTab('profile', this)"><span class="material-symbols-outlined">person</span><span>Profile</span></button>
        </nav>
    </div>

    <div id="notification-overlay">
        <span class="material-symbols-outlined" style="font-size:120px; color:white">notifications_active</span>
        <div style="color:white; font-size:2.5rem; font-weight:bold; margin:20px" id="alert-message">ALERT</div>
        <button class="dismiss-btn" onclick="dismissAlert()">I Understood</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBMw4lAz5iaPSpkK7KaVnFP-cejMTTMHPc",
            authDomain: "fir-empresa-bb9fb.firebaseapp.com",
            databaseURL: "https://fir-empresa-bb9fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fir-empresa-bb9fb",
            storageBucket: "fir-empresa-bb9fb.firebasestorage.app",
            messagingSenderId: "149404088172",
            appId: "1:149404088172:web:3904114b983e9e24266549",
            measurementId: "G-EZP601GZP0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let html5QrCode = null;
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // --- CAMERA LOGIC ---
        window.startCameraSequence = function() {
            // 1. Prepare UI
            const scannerUI = document.getElementById('scanner-ui-container');
            const errorLog = document.getElementById('error-output');
            
            // Unlock audio immediately on user click
            alertSound.play().then(()=> { alertSound.pause(); alertSound.currentTime=0; }).catch(()=>{});

            // Show scanner container FIRST so it has dimensions
            scannerUI.style.display = 'flex';
            errorLog.innerText = "Initializing camera...";

            // 2. Wait 300ms to allow browser to render the div (CRITICAL FIX)
            setTimeout(() => {
                startScanner(errorLog);
            }, 300);
        }

        function startScanner(errorLog) {
            // Check if object exists (it might not if script failed to load)
            if(typeof Html5Qrcode === 'undefined') {
                errorLog.innerText = "Error: QR Library not loaded.";
                return;
            }

            html5QrCode = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // Prefer back camera ("environment")
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                // SUCCESS
                if (decodedText === "67") {
                    html5QrCode.stop().then(() => {
                        document.getElementById('scanner-ui-container').style.display = 'none';
                        document.getElementById('screen-onboarding').classList.remove('active');
                        document.getElementById('screen-app').classList.add('active');
                    }).catch(err => console.error(err));
                } else {
                    alert("Wrong Code! Scan 67.");
                }
            }, 
            (errorMessage) => {
                // Scanning... (ignore frame errors)
            })
            .catch(err => {
                // START ERROR
                console.error(err);
                errorLog.innerText = "Camera Failed: " + err;
                // If back camera fails, try any camera
                if(err.toString().includes("OverconstrainedError")) {
                     errorLog.innerText = "Retrying with any camera...";
                     html5QrCode.start({ facingMode: "user" }, config, /*... logic ...*/); 
                }
            });
        }

        window.cancelScan = function() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-ui-container').style.display = 'none';
                }).catch(() => {
                    document.getElementById('scanner-ui-container').style.display = 'none';
                });
            } else {
                document.getElementById('scanner-ui-container').style.display = 'none';
            }
        }

        // --- APP LOGIC ---
        window.switchTab = function(tab, btn) {
            document.querySelectorAll('.content-area').forEach(e => e.classList.remove('show'));
            document.getElementById('tab-' + tab).classList.add('show');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        const overlay = document.getElementById('notification-overlay');
        const messageEl = document.getElementById('alert-message');
        let lastTimestamp = Date.now();

        onValue(ref(db, 'announcements/latest'), (snapshot) => {
            const data = snapshot.val();
            // Only trigger if APP screen is active (user is logged in)
            if (data && data.timestamp > lastTimestamp && document.getElementById('screen-app').classList.contains('active')) {
                triggerNotification(data.message);
                lastTimestamp = data.timestamp;
            }
        });

        window.triggerNotification = function(msg) {
            messageEl.innerText = msg;
            overlay.classList.add('active');
            alertSound.play().catch(e => console.log(e));
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        }

        window.dismissAlert = function() {
            overlay.classList.remove('active');
            if (navigator.vibrate) navigator.vibrate(0);
        }
    </script>
</body>
</html>