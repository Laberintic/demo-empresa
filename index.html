<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcement Receiver</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <style>
        :root {
            /* Material 3 Color Tokens (simplified) */
            --md-sys-color-primary: #006492;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #cae6ff;
            --md-sys-color-background: #f8fdff;
            --md-sys-color-on-background: #001f2b;
            --md-sys-color-error: #ba1a1a;
            --font-family: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* Large Status Indicator */
        .status-container {
            padding: 2rem;
        }

        .icon-large {
            font-size: 120px;
            color: var(--md-sys-color-primary);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            font-weight: 400;
        }

        p {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-top: 1rem;
        }

        /* The Notification Modal/Overlay */
        #notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--md-sys-color-error); /* Red for alert */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transform: translateY(100%); /* Hidden by default */
            transition: transform 0.4s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        #notification-overlay.active {
            transform: translateY(0);
            animation: flash 1s infinite; /* Visual strobe for accessibility */
        }

        .alert-text {
            color: white;
            font-size: 3rem;
            font-weight: bold;
            padding: 20px;
        }

        .dismiss-btn {
            background: white;
            color: var(--md-sys-color-error);
            border: none;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            margin-top: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Initial Setup Overlay to allow Audio Context */
        #start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
    </style>
</head>
<body>

    <div class="status-container">
        <span class="material-symbols-outlined icon-large">hearing_disabled</span>
        <h1>Listening...</h1>
        <p>Waiting for announcements.</p>
    </div>

    <div id="notification-overlay">
        <span class="material-symbols-outlined" style="font-size: 100px; color: white;">notifications_active</span>
        <div class="alert-text" id="alert-message">ANNOUNCEMENT</div>
        <button class="dismiss-btn" onclick="dismissAlert()">I Understood</button>
    </div>

    <div id="start-overlay">
        <button class="dismiss-btn" style="color: black;" onclick="startApp()">Tap to Start Demo</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";


        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBMw4lAz5iaPSpkK7KaVnFP-cejMTTMHPc",
            authDomain: "fir-empresa-bb9fb.firebaseapp.com",
            databaseURL: "https://fir-empresa-bb9fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fir-empresa-bb9fb",
            storageBucket: "fir-empresa-bb9fb.firebasestorage.app",
            messagingSenderId: "149404088172",
            appId: "1:149404088172:web:3904114b983e9e24266549",
            measurementId: "G-EZP601GZP0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // UI Elements
        const overlay = document.getElementById('notification-overlay');
        const messageEl = document.getElementById('alert-message');
        const startOverlay = document.getElementById('start-overlay');
        
        // Audio Setup
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); // Simple ding sound
        
        // This variable tracks the last timestamp we handled so we don't re-alert on page load
        let lastTimestamp = Date.now();

        // 1. Listen for Database Changes
        const alertsRef = ref(db, 'announcements/latest');
        
        onValue(alertsRef, (snapshot) => {
            const data = snapshot.val();
            
            if (data && data.timestamp > lastTimestamp) {
                triggerNotification(data.message);
                lastTimestamp = data.timestamp;
            }
        });

        function triggerNotification(msg) {
            messageEl.innerText = msg || "ATTENTION";
            overlay.classList.add('active');

            // 1. Play Sound
            alertSound.play().catch(e => console.log("Audio blocked", e));

            // 2. Vibration (Android Only - iOS ignores this)
            if (navigator.vibrate) {
                // Pattern: Vibrate 500ms, pause 200ms, vibrate 500ms
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
        }

        // Global functions for HTML buttons
        window.dismissAlert = function() {
            overlay.classList.remove('active');
            // Stop vibration
            if (navigator.vibrate) navigator.vibrate(0);
        }

        window.startApp = function() {
            startOverlay.style.display = 'none';
            // Play silent sound to unlock audio context on iOS
            alertSound.play().then(() => alertSound.pause()).catch(() => {});
        }
    </script>
</body>
</html>